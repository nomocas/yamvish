<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>yamvish mocha tests</title>
    <link rel="stylesheet" href="./test/mocha.css" />
    <style>
    #fixture {
        position: absolute;
        top: -9999;
        left: -9999;
    }
    
    ;
    </style>
    <script type="text/javascript" src="./dist/yamvish.js"></script>
    <script src="./test/chai.js"></script>
    <script src="./test/mocha.js"></script>
    <script>
    mocha.setup('bdd');
    </script>
    <script src="./test/test.js"></script>
    <script>
    window.onload = function() {
        mocha.run()
    };
    </script>
</head>

<body>
    <h2 style="margin-left:30px;"><a href="https://github.com/nomocas/yamvish">yamvish</a> tests</h2>
    <button onclick="runToElement();">run</button>
    <button onclick="toggleActive();">active</button>
    <button onclick="resetCollection();">reset collection</button>
    <button onclick="unmountElements();">unmount</button>
    <button onclick="mountElements();">mount</button>
    <button onclick="cleanElements();">clean</button>
    <button onclick="runToVirtual();">virtual</button>
    <button onclick="runToString();">string</button>
    <button onclick="runTemplateToString();">templ.string</button>
    <button onclick="runToVirtualToString();">virtual + string</button>
    <button onclick="followedEach();">followed each</button>
    <button onclick="load();">load</button>
    <button onclick="route();">route</button>
    <button onclick="y.navigateTo('/campaign/13/?hello');">/campaign/13/?hello</button>
    <button onclick="y.navigateTo('/campaign/29');">/campaign/29</button>
    <button onclick="validation();">validation</button>
    <button onclick="testNewFunc();">test new func</button>
    <button onclick="expression();">xpres</button>
    <button onclick="dependent();">dependent</button>
    <div id="mocha"></div>
    <script type="text/javascript" src="node_modules/min-history/dist/min-history.min.js"></script>
    <script type="text/javascript">
    history.init({
        hashChangeAlone: true,
        setStateEvent: true,
        basePath: "",
        hid: true
    });
    </script>
    <script type="text/javascript">
    var numNodes = 200;

    function range(size) {
        var output = [];
        for (var i = 0; i < size; ++i)
            output.push(Math.random());
        return output;
    }

    var context = new y.Context({
        data: {
            title: 'Simpler is Better',
            users: ["John", "Bill"],
            range: range(numNodes)
        },
        handlers: {
            hello: function(event) {
                console.log("click hellossss");
            }
        }
    });

    function toggleActive() {
        context.toggle('active');
    }

    var templ = y()
        .on('mounted', function() {
            console.log('mounted. from template');
        })
        .on('unmounted', function() {
            console.log('unmounted. from template');
        })
        .on('destroy', function() {
            console.log('destroy. from template');
        })
        .div(
            y()
            .click('hello')
            .h(1, '{{ title }}')
            .ul(
                y().each('users',
                    y().li('{{ $this }}')
                )
            )
        )
        .div(
            y()
            .attr('hello', 'world')
            .setClass('active')
            .ul(
                y().visible('active')
                .each('range',
                    y().li(
                        y().click(function(evt) {
                            console.log('hello item : ', evt.target.textContent);
                        })
                        .text('{{ $this }}')
                    )
                )
            )
            .div(
                y()
                .click('hello')
                .h(1, '{{ title }}')
            )
        )
        .p('{{ title }} hello {{ title }}');

    var virtualContainer, container;

    function runToElement() {
        try {
            context.data.range = range(numNodes);
            var time = new Date().getTime();

            container = templ.toElement(context).mount("#mocha");

            time = new Date().getTime() - time;
            context.set('range.0', 'Template.toElement.mount : ' + time);
        } catch (e) {
            console.log('error : ', e, e.stack);
        }
    }

    function resetCollection() {
        try {
            var rg = range(numNodes);
            console.time("yamvish context reset collection");
            var time = new Date().getTime();
            context.set('range', rg);
            time = new Date().getTime() - time;
            console.timeEnd("yamvish context reset collection");
            context.set('range.0', 'reset collection : ' + time);
        } catch (e) {
            console.log('error : ', e, e.stack);
        }
    }

    function runToVirtual() {
        try {
            console.time("yamvish Template.toVirtual");
            var time = new Date().getTime();
            virtualContainer = templ.toElement(context, y.Virtual);
            time = new Date().getTime() - time;
            console.timeEnd("yamvish Template.toVirtual");
            context.set('range.0', 'Template.toVirtual : ' + time)
        } catch (e) {
            console.log('error : ', e, e.stack);
        }
    }

    function runTemplateToString() {
        try {
            console.time("yamvish Template.toString");
            var time = new Date().getTime();
            var r = templ.toString(context);
            time = new Date().getTime() - time;
            console.timeEnd("yamvish Template.toString");
            context.set('range.0', 'Template.toString : ' + time);
            console.log('template.toString : ', r);
        } catch (e) {
            console.log('error : ', e, e.stack);
        }
    }

    function runToString() {
        try {
            console.time("yamvish container.toString");
            var time = new Date().getTime();
            var r = virtualContainer.toString();
            time = new Date().getTime() - time;
            console.timeEnd("yamvish container.toString");
            context.set('range.0', 'virtualContainer.toString : ' + time)
            console.log('virtual to string : ', r);
        } catch (e) {
            console.log('error : ', e, e.stack);
        }
    }

    function runToVirtualToString() {
        try {
            console.time("yamvish Template.toVirtual.toString");
            var time = new Date().getTime();
            var r = templ.toElement(context, y.Virtual).toString();
            time = new Date().getTime() - time;
            console.timeEnd("yamvish Template.toVirtual.toString");
            context.set('range.0', 'Template.toVirtual.toString : ' + time)
            console.log('to virtual to string : ', r);
        } catch (e) {
            console.log('error : ', e, e.stack);
        }
    }

    function mountElements() {
        try {
            console.time("yamvish Node.mount");
            var time = new Date().getTime();
            container.mount('#mocha');
            time = new Date().getTime() - time;
            console.timeEnd("yamvish Node.mount");
            context.set('range.0', 'Node.mount : ' + time)
        } catch (e) {
            console.log('error : ', e, e.stack);
        }
    }

    function unmountElements() {
        try {
            console.time("yamvish Node.unmount");
            container.unmount();
            console.timeEnd("yamvish Node.unmount");
        } catch (e) {
            console.log('error : ', e, e.stack);
        }
    }

    function cleanElements() {
        try {
            console.time("yamvish Node.destroy");
            container.destroy();
            console.timeEnd("yamvish Node.destroy");
        } catch (e) {
            console.log('error : ', e, e.stack);
        }
    }


    function followedEach() {
        try {
            console.time("test");
            var time = new Date().getTime();
            var view = new y.View()
                // context
                .set('title', 'Write once. Run everywhere.')
                .set('users', ['Bill', 'Baroud'])
                .set('colors', [{
                    color: 'yellow'
                }, {
                    color: 'pink'
                }, {
                    color: 'piretre'
                }])
                .set('selectedColor', '')
                .rqlView('colors', 'colorsView', 'color=match={{ selectedColor }}&sort(-color)')
                // template
                .h(1, '{{ title }}')
                .input('text', '{{ users.1 }}')
                .input('text', '{{ selectedColor }}')
                .each('users',
                    y().p('{{ $this }}')
                )
                .ul(
                    y().each('colorsView',
                        y().li('{{ color }} colors')
                    )
                )
                .p('{{ title }}')
                // container
                .mount('#mocha')
                .exec(function(context, factory, promises) {
                    promises.push(new Promise(function(resolve, reject) {
                        setTimeout(function() {
                            context.set('title', 'yesss')
                            resolve(true);
                        }, 1000);
                    }));
                });


            view.then(function(s) {
                console.log("view full rendered");
            });

            // context
            view.push('users', 'Biloud')
                .push('users', 'Johnny')
                .del('users.1')
                .set('users.1', 'Rolette')
                .push('colors', {
                    color: 'brown'
                })
                .push('colors', {
                    color: 'black'
                });
            time = new Date().getTime() - time;

            console.timeEnd("test");
            view.set('users.0', 'followed each : ' + time)
        } catch (e) {
            console.log("error ", e, e.stack);
        }
    }

    function load() {
        y.c3po.protocols.text = {
            get: function(req, opt) {
                // async simulation
                return new Promise(function(resolve) {
                    setTimeout(function() {
                        resolve('hello ' + req);
                    }, 1000);
                });
            }
        };
        try {
            console.time("load");
            window.view = new y.View()
                .set('aVar', 'some text')
                .load('title', 'text::{{ aVar }}',
                    y().set('loading', true),
                    y().set('loading', false)
                )
                .div('{{ title }}', y().visible('!loading'))
                .p('loading...', y().visible('loading'))
                .mount('#mocha');

            view.then(function(s) {
                console.log("load end : ", s);
            });
            console.timeEnd("load");
        } catch (e) {
            console.log("error : ", e, e.stack);
        }
    }


    function route() {
        try {
            y.c3po.protocols.campaign = {
                get: function(req, opt) {
                    // async simulation
                    return new Promise(function(resolve) {
                        setTimeout(function() {
                            resolve({
                                title: 'hello campaign ' + req,
                                id: req
                            });
                        }, 1);
                    });
                }
            };

            var view = new y.View()
                .route('/campaign/s:id/?q:query') // should hide/show node if route match or not
                .load('campaign', 'campaign::{{ $route.id + ($route.query || "" )}}') // should load only if variables are all defined (here 'id')
                .h(1, '{{ campaign.title }}')
                .p('{{ campaign.id }}')
                .mount('#mocha');


        } catch (e) {
            console.log("error : ", e, e.stack);
        }
    }

    function validation() {
        try {
            var view = new y.View()
                // .set('title', 'aaa@vbb.com')
                .validate('title', y.aright.rules.email)
                .input('text', '{{ title }}')
                .p('error', y().visible('$error.title'))
                .mount('#mocha');

        } catch (e) {
            console.log("error : ", e, e.stack);
        }
    }

    function testNewFunc() {
        try {

            var parent = new y.Context({
                data: {
                    title: 'fooooo'
                }
            });

            var context = new y.Context({
                parent: parent,
                data: {
                    title: 'hello',
                    index: 2,
                    sum: 3
                }
            });



            var raw = "{{ $.Math.cos(2) * (index+$this.sum) + title + $parent.title + 'hello' }}";

            //console.time("compile");
            var time = new Date().getTime();
            // for (var i = 0; i < 10000; ++i) {
            var xpr = y.interpolable(raw);
            // }
            time = new Date().getTime() - time;

            console.log("xpr :", time, xpr);

            var time = new Date().getTime();
            // for (var i = 0; i < 10000; ++i) {
            var r = xpr.output(context);
            // }
            time = new Date().getTime() - time;
            // console.log('xpr :  ', time, xpr, f.call(context.data, context, typeof window !== 'undefined' ? window : global));
            // console.log('xpr :  ', time, xpr);
            console.log("r : ", time, r);

        } catch (e) {
            console.log("error ", e, e.stack)
        }
        //  alert(time + " - " + f.call(context.data, context, typeof window !== 'undefined' ? window : global));
        // console.timeEnd("compile");

        /*
        console.time("t");
        for (var i = 0; i < 1000; ++i)
          var r = func.call(context.data, context, typeof window !== 'undefined' ? window : global)
        console.timeEnd("t");

        console.log(r)
        */
    }

    function expression() {
        try {
            var parent = new y.Context({
                data: {
                    foo: 'bar'
                }
            });

            var view = new y.View({
                    parent: parent
                })
                .set('title', 'aaa@vbb.com')
                .set('reu', 'feeee')
                .set('deca', function(arg) {
                    return '-hello-' + arg;
                })
                .p('{{ title + deca(true) + $parent.foo + $this.reu + "---" + $.Math.random() }}')
                .mount('#mocha')
                .set('title', 'roooo')
                .set('reu', 'lollipop');

        } catch (e) {
            console.log("error : ", e, e.stack);
        }
    }


    function dependent() {
        try {
            var view = new y.View()
                // .set('title', 'hello world')
                .set('foo', 'bar-')
                .set('zoo', 'flup-')
                .dependent('bloupi', ['foo', 'title'], function(foo, title) {
                    return this.get('zoo') + foo + title;
                })
                .p('{{ bloupi + "-waaaaaaa" }}')
                .mount('#mocha')
                .set('title', 'reu')
                .set('foo', 'ploupiloup');
        } catch (e) {
            console.log("error : ", e, e.stack);
        }
    }
    </script>
</body>

</html>
